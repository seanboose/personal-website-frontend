FROM node:20-alpine AS development-dependencies-env
ARG GH_PACKAGES_PAT
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY . /app
WORKDIR /app
RUN echo "//npm.pkg.github.com/:_authToken=${GH_PACKAGES_PAT}" > /root/.npmrc && \
  pnpm install --frozen-lockfile && \
  rm /root/.npmrc

FROM node:20-alpine AS production-dependencies-env
ARG GH_PACKAGES_PAT
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY ./package.json pnpm-lock.yaml /app/
WORKDIR /app
RUN echo "//npm.pkg.github.com/:_authToken=${GH_PACKAGES_PAT}" > /root/.npmrc && \
  pnpm install --frozen-lockfile --prod && \
  rm /root/.npmrc

FROM node:20-alpine AS build-env
ARG VITE_API_URL
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY . /app/
COPY --from=development-dependencies-env /app/node_modules /app/node_modules
WORKDIR /app
RUN pnpm run build

FROM node:20-alpine
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY ./package.json pnpm-lock.yaml /app/
COPY --from=production-dependencies-env /app/node_modules /app/node_modules
COPY --from=build-env /app/build /app/build
WORKDIR /app
CMD ["pnpm", "run", "start"]
